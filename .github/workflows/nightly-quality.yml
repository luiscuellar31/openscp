name: Nightly Quality

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

jobs:
  sanitizers:
    name: Sanitizers (${{ matrix.sanitizer }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [asan-ubsan, tsan]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build pkg-config clang \
            libssh2-1-dev libssl-dev \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-l10n-tools \
            libgl1-mesa-dev

      - name: Configure (ASan+UBSan)
        if: matrix.sanitizer == 'asan-ubsan'
        env:
          CC: clang
          CXX: clang++
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DOPEN_SCP_BUILD_TESTS=ON \
            -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined"

      - name: Configure (TSan)
        if: matrix.sanitizer == 'tsan'
        env:
          CC: clang
          CXX: clang++
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DOPEN_SCP_BUILD_TESTS=ON \
            -DCMAKE_C_FLAGS="-fsanitize=thread -fno-omit-frame-pointer" \
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=thread"

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        env:
          ASAN_OPTIONS: detect_leaks=1:strict_init_order=1
          UBSAN_OPTIONS: print_stacktrace=1
          TSAN_OPTIONS: halt_on_error=1
        run: ctest --test-dir build --output-on-failure

  static-analysis:
    name: Static Analysis (cppcheck)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck \
            --std=c++20 \
            --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --inline-suppr \
            --suppress=missingIncludeSystem \
            --quiet \
            core/include core/src tests
